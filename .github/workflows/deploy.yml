name: Deploy Chatbot API

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::899659212473:role/GitHubActions-Role
          aws-region: eu-central-1
         
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Generate SSH Key Pair
        run: |
          ssh-keygen -t rsa -b 4096 -f ~/.ssh/chatbot_key -N ""
          chmod 600 ~/.ssh/chatbot_key
          chmod 644 ~/.ssh/chatbot_key.pub

      - name: Terraform Init & Apply
        run: |
          cd infra
          terraform init
          terraform destroy -auto-approve -input=false || true
          terraform apply -auto-approve -input=false -var="ssh_public_key=$(cat ~/.ssh/chatbot_key.pub)"

      - name: Get EC2 Server IP
        id: instance
        run: |
          cd infra
          SERVER_IP=$(terraform output -raw server_ip)
          echo "server_ip=$SERVER_IP" >> $GITHUB_OUTPUT
          echo "Server IP: $SERVER_IP"

      - name: Wait for SSH to be ready
        run: |
          SERVER_IP="${{ steps.instance.outputs.server_ip }}"
          echo "Waiting for SSH to be ready on $SERVER_IP..."
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -i ~/.ssh/chatbot_key ubuntu@$SERVER_IP 'echo SSH Ready' 2>/dev/null; then
              echo "SSH is ready!"
              break
            fi
            echo "Attempt $i/30: SSH not ready yet. Waiting 10 seconds..."
            sleep 10
          done

      - name: Create Ansible Inventory for SSH
        run: |
          echo "[chatbot_server]" > inventory.ini
          echo "${{ steps.instance.outputs.server_ip }} ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/chatbot_key ansible_ssh_common_args='-o StrictHostKeyChecking=no' ansible_become=true" >> inventory.ini

      - name: Install Ansible
        run: |
          pip install ansible

      - name: Run Ansible Playbook via SSH
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          SERVER_PUBLIC_IP: ${{ steps.instance.outputs.server_ip }}
          ANSIBLE_HOST_KEY_CHECKING: 'False'
        run: |
          ansible-playbook -vvv -i inventory.ini ansible/playbook.yml